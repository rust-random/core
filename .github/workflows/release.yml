name: Publish to crates.io and create GitHub release
on:
  push:
    tags: ['v*']
  pull_request:
    branches: 'master'

jobs:
  # Source: https://medium.com/@usman_qb
  release:
    runs-on: ubuntu-latest
    steps:
    - run: ls
    - run: cat CHANGELOG.md
    - name: Create release body
      id: create_release_body
      run: |
        RELEASE_VERSION="${{ github.ref_name }}"
        echo "Version: $RELEASE_VERSION"
        RELEASE_BODY=$(awk -v ver="[${RELEASE_VERSION:1}]" '/^## / { if (p) { exit }; if ($2 == ver) { p=1; next } } p && NF' CHANGELOG.md)
        {
        echo 'RELEASE_BODY<<EOF'
        echo "${RELEASE_BODY}"
        echo EOF
        } >> $GITHUB_OUTPUT

    - name: Create GitHub release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Creating release for ${{ github.ref_name }}"
        echo "${{ steps.create_release_body.outputs.RELEASE_BODY }}"
        gh release create "${{ github.ref_name }}" --title "${{ github.ref_name }}" --notes "${{ steps.create_release_body.outputs.RELEASE_BODY }}"
        echo "Release created successfully"
